<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>UDLR Game</title>
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <style>
      /* Larger grid cells */
      .grid-cell {
        border: 1px solid #ccc;
        width: 100px;
        height: 100px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: center;
        position: relative;
        cursor: pointer;
      }
      /* Small circles for marks */
      .circle {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin: 2px;
        display: inline-block;
      }
      /* Enlarged side areas for hand detection */
      .side-area {
        position: fixed;
        top: 0;
        bottom: 0;
        width: 100px;
        background-color: red;
        z-index: 1000;
      }
      .side-area.left {
        left: 0;
      }
      .side-area.right {
        right: 0;
      }
      /* Option cells styled similar to grid cells */
      .mark-option {
        border: 1px solid #ccc;
        width: 100px;
        height: 100px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin: 0 10px;
      }
      /* Container for sum inputs per set */
      #set-sums {
        margin: 20px 0;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Audio Buttons Section (5 sets) -->
      <div class="row my-3">
        <!-- Each button now uses a default speed of 0.05 -->
        <div class="col text-center">
          <button class="btn btn-primary audio-btn" data-btn="1">
            Play Button 1
          </button>
          <br />
          <input
            type="number"
            class="speed-input"
            data-btn="1"
            value="0.05"
            step="0.05"
            style="width: 60px"
          />
          Speed
        </div>
        <div class="col text-center">
          <button class="btn btn-primary audio-btn" data-btn="2">
            Play Button 2
          </button>
          <br />
          <input
            type="number"
            class="speed-input"
            data-btn="2"
            value="0.05"
            step="0.05"
            style="width: 60px"
          />
          Speed
        </div>
        <div class="col text-center">
          <button class="btn btn-primary audio-btn" data-btn="3">
            Play Button 3
          </button>
          <br />
          <input
            type="number"
            class="speed-input"
            data-btn="3"
            value="0.05"
            step="0.05"
            style="width: 60px"
          />
          Speed
        </div>
        <div class="col text-center">
          <button class="btn btn-primary audio-btn" data-btn="4">
            Play Button 4
          </button>
          <br />
          <input
            type="number"
            class="speed-input"
            data-btn="4"
            value="0.05"
            step="0.05"
            style="width: 60px"
          />
          Speed
        </div>
        <div class="col text-center">
          <button class="btn btn-primary audio-btn" data-btn="5">
            Play Button 5
          </button>
          <br />
          <input
            type="number"
            class="speed-input"
            data-btn="5"
            value="0.05"
            step="0.05"
            style="width: 60px"
          />
          Speed
        </div>
      </div>
      <!-- 4x4 Answer Grid (persistent across sets) -->
      <div class="row justify-content-center">
        <div class="col-auto">
          <div id="grid" class="d-flex flex-wrap" style="width: 420px">
            <!-- Grid cells generated on page load -->
          </div>
        </div>
      </div>
      <!-- Option Cells (for not-confident marking) -->
      <div class="row justify-content-center my-3">
        <div class="mark-option" id="option-left"></div>
        <div class="mark-option" id="option-right"></div>
      </div>
      <!-- Container for Sum Input for each set -->
      <div id="set-sums"></div>
      <!-- Submit Button -->
      <div class="row">
        <div class="col text-right">
          <button class="btn btn-success" id="submit-btn">Submit</button>
        </div>
      </div>
    </div>

    <!-- Side Areas for Hand Detection -->
    <div class="side-area left"></div>
    <div class="side-area right"></div>

    <!-- Modal for Showing Results -->
    <div
      class="modal fade"
      id="resultModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="resultModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="resultModalLabel">Game Results</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="result-text">
            <!-- Results will be injected here -->
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- jQuery and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
      $(document).ready(function () {
        // GLOBAL VARIABLES
        var gridSize = 4;
        var audioLoopCount = 10; // number of audio loops per set
        var activeSet = null; // current set object (if a set is in progress)
        var setsData = []; // array to hold completed set data

        // Each set will record:
        // {
        //   setNumber,
        //   expected: [ {row, col, hand, number (optional)} ... ],
        //   responses: [ {cellType, row?, col?, option?, handUsed} ... ],
        //   spokenNumbers: [ numbers spoken ],
        //   expectedSum: <computed>, userSum: <from input>
        // }

        // Helper: generate grid cells (only once on page load)
        function generateGrid() {
          $("#grid").empty();
          for (var r = 0; r < gridSize; r++) {
            for (var c = 0; c < gridSize; c++) {
              var cell = $(
                '<div class="grid-cell" data-row="' +
                  r +
                  '" data-col="' +
                  c +
                  '"></div>'
              );
              $("#grid").append(cell);
            }
          }
        }
        // Initialize grid on page load
        generateGrid();

        // Side areas touch events to detect which hand is NOT used.
        // (If left area is touched, marking is assumed to be done with the right hand, and vice versa.)
        var activeHand = null;
        $(".side-area").on("touchstart mousedown", function () {
          if ($(this).hasClass("left")) {
            activeHand = "right";
            $(this).css("background-color", "green");
          } else if ($(this).hasClass("right")) {
            activeHand = "left";
            $(this).css("background-color", "green");
          }
        });
        $(".side-area").on("touchend mouseup", function () {
          $(this).css("background-color", "red");
        });

        // When a grid cell is clicked, record the response if a set is active.
        $(document).on("click", ".grid-cell", function () {
          if (!activeSet) {
            alert(
              "Please start an audio set by clicking one of the Play buttons."
            );
            return;
          }
          if (activeHand === null) {
            alert(
              "Please touch and hold a side area first to indicate your hand."
            );
            return;
          }
          // Prevent adding more responses than expected loops
          if (activeSet.responses.length >= activeSet.expected.length) {
            alert("You have already marked for all audio loops in this set.");
            return;
          }
          var cellRow = parseInt($(this).attr("data-row"));
          var cellCol = parseInt($(this).attr("data-col"));
          var response = {
            cellType: "grid",
            row: cellRow,
            col: cellCol,
            handUsed: activeHand,
          };
          activeSet.responses.push(response);
          // Append a small circle with color based on hand used
          var circleColor = activeHand === "right" ? "green" : "yellow";
          var circle = $('<div class="circle"></div>').css(
            "background-color",
            circleColor
          );
          $(this).append(circle);
          activeHand = null;
        });

        // Option cell click (for not-confident marking)
        $(".mark-option").click(function () {
          if (!activeSet) {
            alert(
              "Please start an audio set by clicking one of the Play buttons."
            );
            return;
          }
          if (activeHand === null) {
            alert(
              "Please touch and hold a side area first to indicate your hand."
            );
            return;
          }
          if (activeSet.responses.length >= activeSet.expected.length) {
            alert("You have already marked for all audio loops in this set.");
            return;
          }
          var optionId = $(this).attr("id"); // "option-left" or "option-right"
          var response = {
            cellType: "option",
            option: optionId,
            handUsed: activeHand,
          };
          activeSet.responses.push(response);
          var circleColor = activeHand === "right" ? "green" : "yellow";
          var circle = $('<div class="circle"></div>').css(
            "background-color",
            circleColor
          );
          $(this).append(circle);
          activeHand = null;
        });

        // playAudioLoop: Plays the audio loops for the current set using the Web Speech API.
        function playAudioLoop(setNumber, speed) {
          var currentLoop = 0;
          function playLoop() {
            if (currentLoop >= audioLoopCount) {
              // Wait an extra 3 seconds after the final audio loop before finalizing
              setTimeout(finalizeCurrentSet, 3000);
              return;
            }
            var delay = currentLoop === 0 ? 3000 : 1000;
            setTimeout(function () {
              var directions = [];
              var rowFirst = Math.random() < 0.5;
              var rowGroup, rowExact, colGroup, colExact;
              if (rowFirst) {
                rowGroup = Math.random() < 0.5 ? "UP" : "DOWN";
                rowExact = Math.random() < 0.5 ? "UP" : "DOWN";
                colGroup = Math.random() < 0.5 ? "LEFT" : "RIGHT";
                colExact = Math.random() < 0.5 ? "LEFT" : "RIGHT";
                directions = [rowGroup, rowExact, colGroup, colExact];
              } else {
                colGroup = Math.random() < 0.5 ? "LEFT" : "RIGHT";
                colExact = Math.random() < 0.5 ? "LEFT" : "RIGHT";
                rowGroup = Math.random() < 0.5 ? "UP" : "DOWN";
                rowExact = Math.random() < 0.5 ? "UP" : "DOWN";
                directions = [colGroup, colExact, rowGroup, rowExact];
              }
              // Fifth word: hand indicator
              var handIndicator = Math.random() < 0.5 ? "LEFT" : "RIGHT";
              directions.push(handIndicator);
              // Sixth word: 70% chance of a one-digit number
              var numberSpoken = null;
              if (Math.random() < 0.7) {
                numberSpoken = Math.floor(Math.random() * 9) + 1;
                directions.push(numberSpoken.toString());
              }
              // Compute expected grid cell from the first 4 words.
              var expectedRow, expectedCol;
              if (rowFirst) {
                var rowOptions = rowGroup === "UP" ? [0, 1] : [2, 3];
                expectedRow = rowExact === "UP" ? rowOptions[0] : rowOptions[1];
                var colOptions = colGroup === "LEFT" ? [0, 1] : [2, 3];
                expectedCol =
                  colExact === "LEFT" ? colOptions[0] : colOptions[1];
              } else {
                var colOptions = colGroup === "LEFT" ? [0, 1] : [2, 3];
                expectedCol =
                  colExact === "LEFT" ? colOptions[0] : colOptions[1];
                var rowOptions = rowGroup === "UP" ? [0, 1] : [2, 3];
                expectedRow = rowExact === "UP" ? rowOptions[0] : rowOptions[1];
              }
              // Create expected answer object for this loop.
              var expectedObj = {
                row: expectedRow,
                col: expectedCol,
                hand: handIndicator,
                number: numberSpoken, // may be null
              };
              activeSet.expected.push(expectedObj);
              if (numberSpoken !== null) {
                activeSet.spokenNumbers.push(numberSpoken);
              }
              // Speak the instructions.
              var utteranceText = directions.join(" ");
              var utterance = new SpeechSynthesisUtterance(utteranceText);
              utterance.rate = speed;
              speechSynthesis.speak(utterance);
              currentLoop++;
              utterance.onend = function () {
                playLoop();
              };
            }, delay);
          }
          playLoop();
        }

        // When an audio button is clicked, start a new set.
        $(".audio-btn").click(function () {
          if (activeSet !== null) {
            alert("Finish the current set before starting a new one.");
            return;
          }
          var setNumber = $(this).data("btn");
          var speed = parseFloat(
            $(".speed-input[data-btn='" + setNumber + "']").val()
          );
          // Initialize activeSet object.
          activeSet = {
            setNumber: setNumber,
            expected: [],
            responses: [],
            spokenNumbers: [],
          };
          playAudioLoop(setNumber, speed);
        });

        // After an audio set finishes, finalize it (without resetting the grid).
        function finalizeCurrentSet() {
          // If the user did not mark for all loops, fill missing responses with null.
          while (activeSet.responses.length < activeSet.expected.length) {
            activeSet.responses.push(null);
          }
          // Compute expected sum.
          var expectedSum = activeSet.spokenNumbers.reduce(function (sum, num) {
            return sum + num;
          }, 0);
          activeSet.expectedSum = expectedSum;
          // Append an input for the user to enter the sum for this set.
          var sumInputHtml =
            '<div class="form-group" style="max-width:200px; margin:10px auto;">' +
            "<label>Set " +
            activeSet.setNumber +
            " Sum:</label>" +
            '<input type="number" class="form-control" id="sum-set-' +
            activeSet.setNumber +
            '" placeholder="Enter sum">' +
            "</div>";
          $("#set-sums").append(sumInputHtml);
          // Store the completed set.
          setsData.push(activeSet);
          // Do NOT reset the grid so previous markings persist.
          activeSet = null;
        }

        // When the Submit button is clicked, evaluate all sets.
        $("#submit-btn").click(function () {
          if (setsData.length === 0) {
            alert("No sets have been completed yet.");
            return;
          }
          var resultText = "";
          // For each set, use aggregated matching logic.
          setsData.forEach(function (setData) {
            // First, group expected marks by grid cell.
            var expectedGrid = {}; // key: "grid_r_c"
            setData.expected.forEach(function (exp) {
              var key = "grid_" + exp.row + "_" + exp.col;
              if (!expectedGrid[key]) {
                expectedGrid[key] = { LEFT: 0, RIGHT: 0 };
              }
              expectedGrid[key][exp.hand]++;
            });
            // Group actual grid responses.
            var actualGrid = {}; // key: "grid_r_c"
            setData.responses.forEach(function (resp) {
              if (resp && resp.cellType === "grid") {
                var key = "grid_" + resp.row + "_" + resp.col;
                if (!actualGrid[key]) {
                  actualGrid[key] = { LEFT: 0, RIGHT: 0 };
                }
                actualGrid[key][resp.handUsed] =
                  (actualGrid[key][resp.handUsed] || 0) + 1;
              }
            });
            // Count correct marks from grid responses.
            var totalCorrectGrid = 0,
              leftoverLeft = 0,
              leftoverRight = 0;
            Object.keys(expectedGrid).forEach(function (key) {
              var expCount = expectedGrid[key];
              var actCount = actualGrid[key] || { LEFT: 0, RIGHT: 0 };
              var matchLeft = Math.min(expCount.LEFT, actCount.LEFT);
              var matchRight = Math.min(expCount.RIGHT, actCount.RIGHT);
              totalCorrectGrid += matchLeft + matchRight;
              leftoverLeft += expCount.LEFT - matchLeft;
              leftoverRight += expCount.RIGHT - matchRight;
            });
            // Group actual option responses.
            var actualOptionLeft = 0,
              actualOptionRight = 0;
            setData.responses.forEach(function (resp) {
              if (resp && resp.cellType === "option") {
                if (resp.option === "option-left" && resp.handUsed === "LEFT") {
                  actualOptionLeft++;
                }
                if (
                  resp.option === "option-right" &&
                  resp.handUsed === "RIGHT"
                ) {
                  actualOptionRight++;
                }
              }
            });
            var matchOptionLeft = Math.min(leftoverLeft, actualOptionLeft);
            var matchOptionRight = Math.min(leftoverRight, actualOptionRight);
            var totalCorrect =
              totalCorrectGrid + matchOptionLeft + matchOptionRight;
            var percentCorrect = Math.round(
              (totalCorrect / setData.expected.length) * 100
            );

            // Get the user-entered sum for this set.
            var userSumVal = $("#sum-set-" + setData.setNumber).val();
            var userSum = parseInt(userSumVal);
            var sumResult = "";
            if (userSum === setData.expectedSum) {
              sumResult = "(Correct)";
            } else {
              sumResult = "(Wrong! Must be: " + setData.expectedSum + ")";
            }
            resultText +=
              "<p>Set " +
              setData.setNumber +
              ": " +
              percentCorrect +
              "% Correct<br>Sum: " +
              (isNaN(userSum) ? "Not entered" : userSum) +
              " " +
              sumResult +
              "</p><hr>";
          });
          $("#result-text").html(resultText);
          $("#resultModal").modal("show");
        });
      });
    </script>
  </body>
</html>
